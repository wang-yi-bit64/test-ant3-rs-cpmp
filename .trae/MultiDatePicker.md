# MultiDatePicker 组件需求文档

## 1. 概述

基于 Ant Design 3.26.20 规范和风格的自定义多选日期选择器组件，在不依赖原生 `DatePicker` 多选功能（v3不支持）的前提下，通过自定义日历面板实现多日期选择，确保在 API、交互和视觉上与 Antd 3.x 生态系统无缝集成。

**核心目标**：开发一个功能丰富、性能优良、与 Antd 3.x 完全兼容的 `MultiDatePicker` 组件。

## 2. 功能需求

### 2.1 输入框与触发器
- 使用 Antd Input 组件作为触发器，点击弹出日历面板
- 输入框内以逗号分隔形式显示已选日期（格式示例：`01-15, 01-20`）
- 支持 `placeholder` 属性
- 输入框后缀显示日历图标，有选择值时显示清空图标

### 2.2 Tag 标签展示区
- 在输入框下方固定区域，为每个已选日期渲染一个 Antd Tag
- 每个 Tag 可单独关闭，点击关闭从选择列表中移除对应日期
- 提供"清空"按钮，一键清除所有已选日期

### 2.3 自定义日历面板
- 实现完整的月份视图日历，包括星期标题（日、一、二…六）
- 支持月份切换导航（上个月/下个月按钮）
- 清晰区分当前月日期（正常显示）和非当前月日期（灰显）
- 高亮"今天"日期
- 日期单元格点击交互：
  - 未选中 → 加入列表并高亮显示
  - 已选中 → 从列表移除并取消高亮
  - 选中状态覆盖今天的高亮效果
- 始终保持已选日期列表按时间升序排序

### 2.4 日期禁用 (disabledDate)
- API 完全兼容 Antd DatePicker 的 `disabledDate` 属性
- 函数签名：`(current: moment, info?: { type: string }) => boolean`
- 被禁用的日期应用禁用样式（灰显、不可点击）
- 禁用日期不响应点击和键盘焦点

### 2.5 键盘导航
- **焦点管理**：日历面板弹出后，自动聚焦于面板容器或今天/首个可选日期
- **方向键导航**：
  - ArrowUp：焦点移至上一周同星期几
  - ArrowDown：焦点移至下一周同星期几
  - ArrowLeft：焦点移至前一天
  - ArrowRight：焦点移至后一天
- **功能键**：
  - Enter/Space：选择或取消选择当前焦点所在的日期
  - Esc：关闭日历面板，焦点返回输入框
- **月份切换**：
  - PageUp：切换至上一月
  - PageDown：切换至下一月
  - Home/End：焦点移至当月第一日/最后一日

### 2.6 预设选项 (presets)
- 接收 `presets` 属性，类型为 `Array<{ label: ReactNode, value: moment[] | (() => moment[]) }>`
- 在日历面板底部渲染预设选项区域
- 点击选项可将对应日期数组设为选中值
- **内置快捷选项**：至少提供"今天"、"本周"、"本月"、"最近7天"的默认实现
- **自定义插槽**：提供 `renderExtraFooter?: () => ReactNode` 属性，允许在预设区域下方插入自定义内容

### 2.7 Antd Form 集成
- **受控模式**：完全受控组件，支持 `value`（moment 数组或字符串数组）和 `onChange` 属性
- **事件签名**：`onChange` 回调参数为 `(dates: moment[] | null, dateStrings: string[] | null)`，其中 `dateStrings` 格式为 `YYYY-MM-DD`
- **兼容 getFieldDecorator**：确保能够通过 `getValueFromEvent` 正确解析值（通常使用 `getValueFromEvent: (moments, dateStrings) => dateStrings`）

## 3. UI/UX 一致性要求

### 3.1 视觉风格
- 所有子组件（Button, Tag, Input, Icon）使用 Antd 3.26.20 的默认样式
- 无需自定义主题，保持与 Antd 生态一致

### 3.2 交互反馈
- 悬停、点击状态与 Antd 其他组件保持一致
- 点击组件外部关闭日历面板

### 3.3 无障碍 (A11Y)
- 为焦点元素添加适当的 aria-* 属性（如 `aria-selected`, `aria-disabled`）
- 支持屏幕阅读器
- 键盘导航是核心需求

## 4. 技术约束

### 4.1 开发环境
- React 16.x+（兼容 React 17 Hooks 用法）
- Ant Design 3.26.20
- 日期库：使用 moment（与 Antd 3.x 保持一致，不兼容 dayjs）

### 4.2 样式方案
- 直接引入 `antd/dist/antd.css`
- 组件自定义样式使用带前缀的类名或行内样式，避免污染全局样式

### 4.3 性能要求
- 快速切换月份时无明显卡顿
- `disabledDate` 函数不会因过度调用导致性能问题
- 对重复渲染的 UI 使用 `useMemo`/`useCallback` 缓存

## 5. 验收测试要点

### 5.1 基础功能测试
- 正常选择、取消选择、清空日期
- 输入框和 Tag 区正确显示已选日期
- 逗号分隔格式正确

### 5.2 Antd 兼容性测试
- `disabledDate` 函数正确接收 moment 对象并返回布尔值
- 组件能通过 `getFieldDecorator` 在 Form 表单中正常工作和验证
- `onChange` 事件参数格式正确

### 5.3 键盘操作测试
- 仅通过键盘完成所有选择、导航、关闭操作
- 焦点逻辑正确，键盘导航流畅
- Esc 键正确关闭面板并返回焦点

### 5.4 预设功能测试
- 点击"最近7天"等预设，正确选中对应的多个日期
- 预设值正确转换为独立的日期数组
- 自定义预设功能正常工作

### 5.5 性能测试
- 月份切换流畅，无卡顿
- 大量日期选择时性能良好
- 内存使用合理

## 6. 特别说明与开发提示

### 6.1 预设值转换逻辑
- "最近7天"：转换为从6天前到今天共7个 moment 对象的数组
- "本周"：转换为当前周的所有日期
- "本月"：转换为当前月的所有日期
- 预设范围需要转换为独立的日期数组交给多选逻辑处理

### 6.2 键盘焦点管理
- 面板打开时初始焦点策略：
  - 有选中日期 → 焦点落在最后一个选中日期上
  - 无选中日期 → 焦点落在"今天"上
- 键盘导航时，当前获得焦点的日期单元格必须有清晰的可视化样式（如外发光或边框）
- 焦点样式需区别于鼠标悬停和选中状态

### 6.3 日期处理
- 使用 moment 进行所有日期计算和格式化
- 日期比较使用 moment 的 `isSame`、`isBefore`、`isAfter` 等方法
- 日期格式化统一使用 `YYYY-MM-DD` 格式

### 6.4 组件状态管理
- 使用 React Hooks（`useState`, `useEffect`, `useMemo`, `useCallback`）
- 确保 React 16/17 兼容性
- 避免不必要的重新渲染

## 7. 文件结构规范

```
src/components/MultiDatePicker/
├── index.jsx              # 组件主文件
├── index.d.ts             # TypeScript 类型定义（可选）
├── index.css              # 组件样式
├── tests /
│   └── MultiDatePicker.test.jsx  # 单元测试
├── demo.jsx               # 使用示例
└── README.md              # 组件文档
```

## 8. 开发工作流

1. **需求分析**：理解本需求文档的所有要求
2. **组件设计**：设计组件 API 和内部状态结构
3. **实现核心功能**：按优先级实现功能（基础选择 → 键盘导航 → 预设功能）
4. **样式集成**：确保与 Antd 3.x 视觉风格一致
5. **测试编写**：编写单元测试覆盖所有功能点
6. **性能优化**：优化渲染性能和内存使用
7. **文档编写**：提供使用示例和 API 文档
8. **验收测试**：按照第5节进行完整测试